# Bot de Controle de Frota de Viaturas

Este √© um bot para Telegram desenvolvido em Node.js para gerenciar e controlar o uso de uma frota de viaturas. O sistema implementa um fluxo completo de solicita√ß√£o, vistoria, autoriza√ß√£o, e registro de uso, garantindo que todo o processo seja documentado e audit√°vel.

## üìã Funcionalidades Principais

* **Fluxo de Solicita√ß√£o Completo:** Desde o pedido do usu√°rio at√© a devolu√ß√£o da chave, passando por m√∫ltiplas etapas de aprova√ß√£o.
* **Gerenciamento de Permiss√µes:** O sistema conta com 4 n√≠veis de usu√°rio, cada um com suas responsabilidades e comandos espec√≠ficos.
* **Notifica√ß√µes em Tempo Real:** Usu√°rios e respons√°veis s√£o notificados a cada etapa do processo.
* **Controle de Quilometragem:** O solicitante deve informar o KM inicial e final, registrando o total percorrido.
* **Gerenciamento da Frota:** Vistoriadores podem cadastrar novas viaturas e atualizar o status das existentes (ex: em manuten√ß√£o, dispon√≠vel, etc.).
* **Autentica√ß√£o de Usu√°rio:** O primeiro acesso requer autentica√ß√£o via CPF e Matr√≠cula, vinculando a conta do Telegram a um usu√°rio pr√©-cadastrado no sistema.
* **Persist√™ncia de Dados:** Utiliza um banco de dados MySQL para armazenar informa√ß√µes de usu√°rios, viaturas e logs de solicita√ß√µes.

## üîÑ O Fluxo de Solicita√ß√£o de Viatura

O cora√ß√£o do bot √© o fluxo de solicita√ß√£o, que segue as seguintes etapas:

1.  **Solicita√ß√£o:** Um usu√°rio com permiss√£o de `solicitante` inicia o processo com o comando `/solicitarviatura`.
2.  **Termo de Responsabilidade:** O solicitante deve ler e aceitar os termos de responsabilidade para prosseguir.
3.  **Informa√ß√µes da Miss√£o:** O solicitante informa a data, a hora e o motivo para a necessidade da viatura. A solicita√ß√£o deve ter uma anteced√™ncia m√≠nima configur√°vel (padr√£o de 30 minutos).
4.  **Notifica√ß√£o ao Vistoriador:** Ap√≥s o envio, todos os `vistoriadores` recebem uma notifica√ß√£o para atender ao pedido.
5.  **Vistoria e Sele√ß√£o:** Um `vistoriador` atende ao chamado, analisa o pedido e seleciona uma viatura dispon√≠vel no sistema para aquela miss√£o. A viatura selecionada fica com o status "reservada".
6.  **Notifica√ß√£o ao Autorizador:** Com a viatura selecionada, todos os `autorizadores` s√£o notificados para aprovar ou negar a solicita√ß√£o.
7.  **Decis√£o do Autorizador:** Um `autorizador` aprova ou nega. Se negada, a viatura volta a ficar "dispon√≠vel". Se aprovada, os `r√°dio-operadores` s√£o notificados.
8.  **Libera√ß√£o das Chaves:** Um `r√°dio-operador` entrega as chaves ao solicitante e marca a a√ß√£o no bot.
9.  **Registro de KM:** O solicitante recebe a viatura e √© instru√≠do a informar a quilometragem **inicial**. A viatura passa para o status "em uso". Ao final da miss√£o, o solicitante devolve a viatura e informa a quilometragem **final**.
10. **Finaliza√ß√£o:** Com o KM final informado, a solicita√ß√£o √© conclu√≠da, a viatura volta ao status "dispon√≠vel" e um resumo completo da miss√£o √© gerado para o solicitante.

## üë• Perfis de Usu√°rio e Permiss√µes

As permiss√µes s√£o hier√°rquicas, ou seja, um usu√°rio de n√≠vel superior tem acesso a todos os comandos dos n√≠veis inferiores.

| N√≠vel | Perfil | Responsabilidades e Comandos |
| :---: | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 4 | **Autorizador** | Aprova ou nega solicita√ß√µes que j√° foram vistoriadas. |
| 3 | **Vistoriador** | Atende √†s solicita√ß√µes, seleciona viaturas, cadastra novos ve√≠culos (`/addviatura`), lista todos os ve√≠culos (`/listviaturas`), atualiza o status de qualquer viatura (`/updatestatus`) e pode pr√©-cadastrar novos usu√°rios no sistema (`/adduser`). |
| 2 | **R√°dio-Operador** | Entrega as chaves das viaturas para solicita√ß√µes j√° autorizadas e registra essa entrega no bot. |
| 1 | **Solicitante** | Inicia o bot (`/start`), solicita viaturas (`/solicitarviatura`), verifica o status de suas pr√≥prias solicita√ß√µes (`/status`) e pede ajuda (`/help`). |

## üöÄ Comandos Dispon√≠veis

| Comando | Descri√ß√£o | N√≠vel M√≠nimo |
| :--- | :--- | :--- |
| `/start` | Inicia a intera√ß√£o com o bot e mostra a mensagem de boas-vindas. | Solicitante |
| `/solicitarviatura` | Inicia o fluxo para solicitar uma nova viatura. | Solicitante |
| `/status` | Exibe o status das suas √∫ltimas solicita√ß√µes. | Solicitante |
| `/help` | Mostra uma mensagem detalhada de ajuda. | Solicitante |
| `/adduser` | Inicia o fluxo para pr√©-cadastrar um novo usu√°rio no sistema. | Vistoriador |
| `/addviatura` | Inicia o fluxo para cadastrar uma nova viatura na frota. | Vistoriador |
| `/listviaturas` | Lista todas as viaturas cadastradas e seus status atuais. | Vistoriador |
| `/updatestatus` | Permite alterar manualmente o status de uma viatura. | Vistoriador |
| `/debug`| Mostra informa√ß√µes de depura√ß√£o sobre o usu√°rio e o sistema. | Solicitante |

## üõ†Ô∏è Tecnologias Utilizadas

* **Plataforma:** Node.js
* **API Telegram:** `node-telegram-bot-api`
* **Banco de Dados:** MySQL (`mysql2/promise`)
* **Vari√°veis de Ambiente:** `dotenv`

## üìÇ Estrutura do Projeto

```
/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ botHandlers.js      # Define todos os handlers para comandos e callbacks do bot.
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ authService.js        # L√≥gica de autentica√ß√£o e gerenciamento de usu√°rios.
‚îÇ   ‚îú‚îÄ‚îÄ requestService.js     # Controla todo o fluxo de uma solicita√ß√£o de viatura.
‚îÇ   ‚îú‚îÄ‚îÄ statusService.js      # L√≥gica para atualiza√ß√£o de status das viaturas.
‚îÇ   ‚îî‚îÄ‚îÄ vehicleService.js     # L√≥gica para o cadastro de novas viaturas.
‚îú‚îÄ‚îÄ .env                    # Arquivo local com as vari√°veis de ambiente (n√£o versionado).
‚îú‚îÄ‚îÄ .gitignore              # Especifica arquivos e pastas a serem ignorados pelo Git.
‚îú‚îÄ‚îÄ config.js               # Carrega e exporta as configura√ß√µes e vari√°veis de ambiente.
‚îú‚îÄ‚îÄ db.js                   # Gerencia a conex√£o com o banco de dados e exporta as queries.
‚îú‚îÄ‚îÄ main.js                 # Ponto de entrada da aplica√ß√£o, inicializa o bot.
‚îú‚îÄ‚îÄ state.js                # (Deprecado/Refatorado) Gerenciador de estado inicial.
‚îú‚îÄ‚îÄ stateManager.js         # Gerenciador de estado moderno, usando DB para sess√µes.
‚îî‚îÄ‚îÄ utils.js                # Fun√ß√µes utilit√°rias (formata√ß√£o, valida√ß√£o, permiss√µes).
```

## ‚öôÔ∏è Configura√ß√£o e Instala√ß√£o

1.  **Pr√©-requisitos:**
    * Node.js (v16 ou superior)
    * NPM
    * Um servidor de banco de dados MySQL.

2.  **Clonar o Reposit√≥rio:**
    ```bash
    git clone https://URL-DO-SEU-REPOSITORIO.git
    cd nome-do-projeto
    ```

3.  **Instalar Depend√™ncias:**
    ```bash
    npm install
    ```

4.  **Configurar o Banco de Dados:**
    Execute o seguinte script SQL no seu banco de dados para criar as tabelas necess√°rias.

    ```sql
    CREATE TABLE usuarios (
        id INT AUTO_INCREMENT PRIMARY KEY,
        telegram_id VARCHAR(255) UNIQUE,
        nome VARCHAR(255),
        cpf VARCHAR(11) UNIQUE NOT NULL,
        matricula VARCHAR(50) UNIQUE NOT NULL,
        tipo_usuario ENUM('solicitante', 'radio_operador', 'vistoriador', 'autorizador') NOT NULL,
        ativo BOOLEAN DEFAULT TRUE,
        data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE viaturas (
        id INT AUTO_INCREMENT PRIMARY KEY,
        prefixo VARCHAR(50) UNIQUE NOT NULL,
        nome VARCHAR(255) NOT NULL,
        modelo VARCHAR(100),
        placa VARCHAR(10) UNIQUE,
        km_atual INT DEFAULT 0,
        status ENUM('disponivel', 'cedida', 'baixada', 'disposicao', 'manutencao', 'reservada', 'em_uso') NOT NULL,
        data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE logs_solicitacoes (
        id INT AUTO_INCREMENT PRIMARY KEY,
        codigo_solicitacao VARCHAR(50) UNIQUE NOT NULL,
        solicitante_id VARCHAR(255),
        solicitante_nome VARCHAR(255),
        solicitante_cpf VARCHAR(11),
        solicitante_matricula VARCHAR(50),
        data_solicitacao DATETIME,
        data_necessidade DATETIME,
        motivo TEXT,
        status_final VARCHAR(50),
        viatura_id INT,
        viatura_prefixo VARCHAR(50),
        viatura_nome VARCHAR(255),
        viatura_placa VARCHAR(10),
        vistoriador_id VARCHAR(255),
        vistoriador_nome VARCHAR(255),
        data_vistoria DATETIME,
        autorizador_id VARCHAR(255),
        autorizador_nome VARCHAR(255),
        data_decisao DATETIME,
        radio_operador_id VARCHAR(255),
        radio_operador_nome VARCHAR(255),
        data_entrega DATETIME,
        km_inicial INT,
        km_final INT,
        observacoes TEXT,
        FOREIGN KEY (viatura_id) REFERENCES viaturas(id)
    );

    CREATE TABLE user_sessions (
        telegram_id VARCHAR(255) PRIMARY KEY,
        session_data JSON,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    );
    ```

5.  **Configurar Vari√°veis de Ambiente:**
    Crie um arquivo `.env` na raiz do projeto, copiando o conte√∫do de um `.env.example` (se houver) ou usando o modelo abaixo.

    ```env
    # Token do seu bot, obtido com o @BotFather no Telegram
    TELEGRAM_BOT_TOKEN="SEU_TOKEN_AQUI"

    # Configura√ß√µes do Banco de Dados
    DB_HOST="localhost"
    DB_USER="root"
    DB_PASSWORD="sua_senha_do_banco"
    DB_DATABASE="bot_viaturas"
    DB_PORT=3306

    # Configura√ß√µes do Bot
    ANTECEDENCIA_MINIMA_MINUTOS=30
    ```

6.  **Povoar o Banco (Opcional, mas recomendado):**
    Para que o bot funcione, √© preciso ter usu√°rios pr√©-cadastrados. Um `vistoriador` pode usar o comando `/adduser`, mas para o primeiro `vistoriador`, voc√™ precisar√° inseri-lo manualmente no banco:
    ```sql
    INSERT INTO usuarios (cpf, matricula, tipo_usuario, ativo) VALUES ('11122233344', '12345', 'vistoriador', TRUE);
    ```
    Depois disso, o usu√°rio correspondente a esse CPF/Matr√≠cula pode fazer o primeiro acesso no bot para vincular seu Telegram e cadastrar outros usu√°rios.

## ‚ñ∂Ô∏è Como Executar

Ap√≥s a configura√ß√£o, inicie o bot com o seguinte comando:

```bash
node main.js
```

Ou, caso tenha o `nodemon` instalado para desenvolvimento:

```bash
nodemon main.js
```

---